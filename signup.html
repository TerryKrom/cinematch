<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="shortcut icon" href="assets/images/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/login.css">
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css"/>
    <link rel="stylesheet" href="assets/css/animations.css">
  </head>
<body>
    <header>
      <div class="container-logo">
        <a href="#"><img src="assets/images/popcorn.png" alt="CineMatch" class="logo">
        </a>
        <h2 id="textlogo">
          <span style="color: #dc041c">C</span><span>I</span><span>N</span><span>E</span><span style="color: #dc041c">M</span><span>A</span><span>T</span><span>C</span><span>H</span>
        </h2>
      </div>
      <a href="./login.html" class="btn-menu">Fazer Login</a>  
    </header>  
    <div class="login-card">
      <h2>Criar Conta</h2>
      <h3>Insira suas credenciais</h3>
      <form class="login-form">
        <input type="text" placeholder="Nome">
        <input type="email" placeholder="E-mail" />
        <input type="password" placeholder="Senha" />
        <button type="button" id="google-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google" viewBox="0 0 16 16">
            <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.792 4.792 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.702 3.702 0 0 0 1.599-2.431H8v-3.08h7.545z"/>
          </svg>
        </button>
        <button type="submit">Cadastrar</button>
    </form>
    </div>


    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
<script type="module">
  // Importações do Firebase e do Firebase Authentication
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  
  import { getFirestore, collection, addDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  

  const firebaseConfig = {
          apiKey: "AIzaSyDpQcKbYfP6PWYo4186zfLKP9vlfZjC5YE",
          authDomain: "cinematch-3e757.firebaseapp.com",
          projectId: "cinematch-3e757",
          storageBucket: "cinematch-3e757.appspot.com",
          messagingSenderId: "372273255417",
          appId: "1:372273255417:web:aea0cdab837d2baaf5e328",
          measurementId: "G-JELQB2MP41"
        };
        
  // Inicialização do Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getFirestore(app);

  const setUserDataInLocalStorage = (user) => {
    localStorage.setItem('User', user.displayName);
    if (user.photoURL) {
      localStorage.setItem('UserImg', user.photoURL);
    } else {
      localStorage.setItem('foto', 'false');
    }
  };

  const signInWithGoogle = () => {
  const provider = new GoogleAuthProvider();
  signInWithPopup(auth, provider)
    .then(async (result) => {
      // Login bem-sucedido, redirecionar para página de sucesso ou realizar outras ações
      console.log("Login com Google realizado com sucesso:", result.user);
      const displayName = result.user.displayName;
      localStorage.setItem('User', displayName);
      localStorage.setItem('UserImg', result.user.photoURL);
      const email = result.user.email;

      const querySnapshot = await getDocs(collection(db, "usuarios"), where("email", "==", email));

      if (querySnapshot.empty) {
        // A conta do Google não foi registrada anteriormente, adicionar no Firestore
        await addDoc(collection(db, "usuarios"), {
          nome: displayName,
          email: email
        });
        console.log("Conta do Google adicionada ao Firestore com sucesso!");
      }
      window.location.href = './index.html';
    })
    .catch((error) => {
      // Tratar erros de login
      console.log("Erro no login com Google:", error);
    });
};

  const googleButton = document.getElementById('google-btn');
  googleButton.addEventListener('click', signInWithGoogle);

  const form = document.querySelector('.login-form');

  form.addEventListener('submit', (e) => {
  e.preventDefault();

  const nome = form.querySelector('input[type="text"]').value;
  const email = form.querySelector('input[type="email"]').value;
  const senha = form.querySelector('input[type="password"]').value;

  createUserWithEmailAndPassword(auth, email, senha)
    .then((userCredential) => {
      // Usuário criado com sucesso
      const user = userCredential.user;
      console.log("Usuário criado com sucesso:", user);

      // Salvar dados do usuário no Firestore
      addDoc(collection(db, "usuarios"), {
        nome: nome,
        email: email,
        senha: senha
        // Você pode adicionar outros campos desejados aqui
      })
        .then((docRef) => {
          console.log("Dados inseridos com sucesso no Firestore. ID do documento:", docRef.id);
          setUserDataInLocalStorage({ displayName: nome });
          localStorage.setItem('foto', 'false'); // Define o campo 'foto' como falso
          window.location.href = '/index.html';
        })
        .catch((error) => {
          console.error("Erro ao inserir dados no Firestore:", error);
        });
    })
    .catch((error) => {
      console.error("Erro ao criar usuário:", error);
    });
});

</script> 
  </body>
</html>

